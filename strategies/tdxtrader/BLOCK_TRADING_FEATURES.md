# tdxtrader板块交易功能详解

## 🧠 系统架构

```
通达信预警文件/板块文件 → tdxtrader监听 → EasyXT API → QMT交易终端
```

### 核心组件

- **通达信预警文件/板块文件**：通达信软件生成的预警信号文件（sign.txt）或自定义板块文件（.blk）
- **tdxtrader模块**：监听文件变化并解析信号
- **EasyXT API**：封装QMT交易接口，提供简化的交易API
- **QMT交易终端**：迅投QMT实盘交易系统

## 📁 项目结构

```
strategies/tdxtrader/
├── BLOCK_TRADING_FEATURES.md         # 板块交易功能详解文档
├── README.md                         # 项目主文档
├── tdxtrader_integration_example.py  # 集成示例
├── .gitignore                        # Git忽略文件
├── config/                           # 配置文件目录
│   └── tdx_easyxt_config.json        # EasyXT集成配置文件
├── tdxtrader/                        # tdxtrader核心模块
│   ├── __init__.py                   # 包初始化文件
│   ├── index.py                      # 主入口模块
│   ├── trader.py                     # 交易对象管理
│   ├── order.py                      # 订单处理逻辑
│   ├── file.py                       # 文件读取处理
│   ├── logger.py                     # 日志处理模块
│   ├── utils.py                      # 工具函数
│   └── anis.py                       # 终端颜色输出
└── logs/                             # 日志目录（运行时生成）
```

## 📋 概述

tdxtrader支持两种交易触发方式：

1. **预警文件触发**：基于通达信技术指标预警生成的信号文件（sign.txt）
2. **板块文件触发**：基于通达信自定义板块文件（.blk）的变化

板块交易功能是基于通达信自定义板块文件的自动化交易机制。通过监控指定的板块文件变化，当股票被添加到买入板块或从买入板块移除时，系统会自动触发相应的买入或卖出操作。

相比传统的预警文件触发方式，板块交易提供了更直观、更灵活的交易触发机制，用户可以直接在通达信软件中通过拖拽股票到自定义板块来触发交易。

## 🚀 核心优势

### 1. 直观操作
- 无需编写复杂的预警公式
- 直接在通达信中通过拖拽股票到板块即可触发交易
- 操作简单，学习成本低

### 2. 实时同步
- 板块文件变化实时检测
- QMT同步下单，无延迟
- 支持买入和卖出双向操作

### 3. 灵活配置
- 支持多个板块文件同时监控
- 可自定义买入板块和卖出板块
- 与预警文件触发方式可同时使用

### 4. 双重触发机制
- **预警文件触发**：技术指标自动化触发
- **板块文件触发**：手动选股实时触发
- 两种方式可独立使用或组合使用，满足不同交易场景

## 📁 板块文件格式

通达信自定义板块文件(.blk)格式简单明了：

```
000001
000002
600001
600002
```

每行一个6位数字股票代码，系统会自动识别并处理。

## ⚙️ 配置说明

### 1. 统一配置文件

tdxtrader使用项目根目录的统一配置文件，同时也支持本地配置文件 `config/tdx_easyxt_config.json`：

```json
{
    "tdx_file_path": "D:/new_tdx/sign.txt",
    "interval": 1,
    "buy_signals": [
        "KDJ买入条件选股",
        "MACD买入条件选股"
    ],
    "sell_signals": [
        "KDJ卖出条件选股",
        "MACD卖出条件选股"
    ],
    "cancel_after": 10,
    "wechat_webhook_url": null,
    "default_volume": 100,
    "price_type": "市价",
    "block_files": {
        "D:/new_tdx/T0002/blocknew/MR.blk": "buy",
        "D:/new_tdx/T0002/blocknew/MC.blk": "sell"
    }
}
```

### 2. 板块文件配置说明

板块文件配置在 `block_files` 字段中，格式为：

```json
"block_files": {
    "板块文件路径": "操作类型"
}
```

- **板块文件路径**：通达信自定义板块文件的完整路径
- **操作类型**："buy"表示买入操作，"sell"表示卖出操作

### 配置参数说明

| 参数 | 类型 | 说明 |
|------|------|------|
| `block_files` | dict | 板块文件路径与操作类型的映射 |
| `路径` | string | 通达信板块文件的完整路径 |
| `操作类型` | string | "buy"表示买入，"sell"表示卖出 |

## 🔄 工作原理

### 1. 文件监控机制
```
[定期检查] → [文件修改时间对比] → [内容变化检测] → [触发交易]
```

系统每秒检查一次板块文件的修改时间，如果发现文件被修改，则读取文件内容并与上次内容进行对比。

### 2. 股票变化检测
- **新增股票**：当前文件中有但上次文件中没有的股票 → 触发买入操作
- **移除股票**：上次文件中有但当前文件中没有的股票 → 触发卖出操作

### 3. 交易执行流程
```
股票变化检测 → 调用事件处理函数 → EasyXT下单 → 备选方案(xt_trader)
```

## 🛠️ 使用步骤

### 1. 创建自定义板块
1. 打开通达信软件
2. 进入"自定义板块"管理界面
3. 创建新的自定义板块（如"买入信号"、"卖出信号"）

### 2. 配置板块文件路径
在代码中配置板块文件的完整路径：
```python
mr_block_path = r"D:\new_tdx\T0002\blocknew\买入信号.blk"
mc_block_path = r"D:\new_tdx\T0002\blocknew\卖出信号.blk"
```

### 3. 启动交易系统
运行集成示例代码，系统会自动监控板块文件变化。

### 4. 触发交易
- **买入操作**：将股票拖拽到买入板块
- **卖出操作**：将股票从卖出板块移除

## 📊 实时监控

系统提供详细的日志输出，便于实时监控交易状态：

```
[INFO] 从板块文件 MR.blk 读取到 13 只股票: ['600519', '000009', ...]
[INFO] 板块文件 MR.blk 发生变化，开始处理
[INFO] 新增股票: {'600519'}
[INFO] 板块 MR.blk 新增 1 只股票，触发买入操作
[INFO] 准备通过xt_trader执行买入委托: 股票=600519.SH, 数量=100, 价格=市价
[INFO] 异步买入委托已提交，序列号: 123456
```

## 🔧 技术实现

### 核心函数

#### `process_block_files()`
```python
def process_block_files(xt_trader, account, block_files, buy_event, sell_event):
    """
    处理板块文件，检测股票变化并触发相应操作
    """
```

#### `process_stocks_for_operation()`
```python
def process_stocks_for_operation(xt_trader, account, stocks, operation, event_handler):
    """
    处理股票列表并执行相应操作
    """
```

### 双重保险机制
1. **主通道**：EasyXT高级API异步下单
2. **备选通道**：xt_trader原生API异步下单

当主通道下单失败时，系统会自动切换到备选通道，确保交易的可靠性。

## ⚠️ 注意事项

### 1. 文件路径
- 确保板块文件路径正确无误
- 板块文件必须是通达信标准的.blk格式
- 系统会自动处理股票代码的市场后缀(SH/SZ)

### 2. 权限设置
- 确保Python程序有读取板块文件的权限
- 确保QMT客户端正常运行并已登录

### 3. 交易时间
- 板块交易仅在交易时间内有效
- 非交易时间的板块变化会在下次启动时处理

### 4. 网络环境
- 确保网络连接稳定
- 建议使用模拟盘测试后再进行实盘交易

## 🎯 应用场景

### 1. 手动选股自动化
- 通过技术分析选出股票后，直接拖拽到买入板块
- 系统自动执行买入操作
- 适合短线交易者和波段操作者

### 2. 投资组合管理
- 将持仓股票加入卖出板块
- 当决定卖出时，从板块中移除即可自动执行卖出
- 适合中长线投资者进行持仓管理

### 3. 策略信号执行
- 将量化策略选出的股票自动写入买入板块
- 实现策略信号到交易执行的自动化
- 适合程序化交易和量化投资者

### 4. 混合交易模式
- 同时使用预警文件和板块文件触发
- 技术面信号自动触发，基本面信号手动触发
- 实现更灵活的交易策略组合

## 📈 性能特点

### 1. 高效检测
- 毫秒级文件变化检测
- 智能缓存机制，避免重复读取

### 2. 稳定执行
- 双重保险下单机制
- 完善的异常处理和错误恢复

### 3. 低资源占用
- 轻量级监控机制
- 合理的轮询间隔设置

## 🆘 常见问题

### Q: 板块文件变化但没有触发交易？
A: 检查以下几点：
1. 板块文件路径是否正确
2. QMT客户端是否正常运行
3. 系统是否在交易时间内
4. 查看日志文件确认错误信息

### Q: 如何确认交易是否成功执行？
A: 通过以下方式确认：
1. 查看控制台实时日志输出
2. 检查QMT客户端的委托记录
3. 查看系统生成的交易日志文件

### Q: 板块交易与预警文件可以同时使用吗？
A: 可以，两者互不冲突，可以同时监控预警文件和板块文件。

## 📚 相关文档

- [README.md](README.md) - 项目主文档
- [集成示例](tdxtrader_integration_example.py) - 完整使用示例
- [技术文档](../../README.md) - EasyXT技术文档
- [统一配置说明](../../config/unified_config.json) - 系统统一配置文件

---
*量化为王，策略致胜，我是只聊干货的王者 quant！*