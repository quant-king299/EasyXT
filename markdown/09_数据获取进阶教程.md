# EasyXT第九课：数据获取进阶教程

**项目地址**: https://github.com/quant-king299/EasyXT

## 学习目标

本课程将深入学习xtquant数据获取的高级功能，包括：
- 多种数据获取方式和技巧
- 实时行情数据处理
- 多周期数据分析
- 数据质量检查与验证
- 数据导出与存储

## 代码示例

### 第一步：模块导入与初始化

```python
import sys
import os

# 添加项目根目录到Python路径
current_dir = os.path.dirname(os.path.abspath(__file__))
parent_dir = os.path.dirname(current_dir)
sys.path.insert(0, parent_dir)

try:
    import xtquant.xtdata as xt
    print("✅ 成功导入xtquant.xtdata模块")
except ImportError as e:
    print(f"❌ 导入xtquant.xtdata失败: {e}")
    print("尝试其他导入方式...")
    
    try:
        # 尝试直接从xtquant目录导入
        xtquant_path = os.path.join(parent_dir, 'xtquant')
        if os.path.exists(xtquant_path):
            sys.path.insert(0, xtquant_path)
            import xtdata as xt
            print("✅ 成功从xtquant目录导入xtdata模块")
        else:
            raise ImportError("找不到xtquant目录")
    except ImportError:
        print("❌ 无法导入任何xtdata模块")
        print("请检查xtquant是否正确安装")
        sys.exit(1)

import pandas as pd
import numpy as np
from datetime import datetime, timedelta
import time
```

### 运行效果预览

```
✅ 成功导入xtquant.xtdata模块
============================================================
MiniQMT 数据获取学习实例 - 改进版
============================================================
```

### 第二步：基础行情数据获取

```python
def get_basic_market_data():
    """获取基础行情数据"""
    print("\n1. 基础行情数据获取")
    print("-" * 40)
    
    # 定义股票代码
    stock_codes = ['000001.SZ', '600000.SH', '000002.SZ']
    
    try:
        # 获取最近30天的日线数据
        print("获取日线数据...")
        data = xt.get_market_data_ex(
            stock_list=stock_codes,
            period='1d',
            count=30
        )
        
        for stock_code in stock_codes:
            if stock_code in data:
                df = data[stock_code]
                print(f"\n{stock_code} 数据概览:")
                print(f"  数据条数: {len(df)}")
                print(f"  最新价格: {df['close'].iloc[-1]:.2f}")
                print(f"  最高价: {df['high'].max():.2f}")
                print(f"  最低价: {df['low'].min():.2f}")
                print(f"  平均成交量: {df['volume'].mean():.0f}")
            else:
                print(f"{stock_code}: 数据获取失败")
                
    except Exception as e:
        print(f"获取行情数据失败: {e}")
```

### 运行效果预览

```
1. 基础行情数据获取
----------------------------------------
获取日线数据...

000001.SZ 数据概览:
  数据条数: 30
  最新价格: 12.58
  最高价: 13.25
  最低价: 11.89
  平均成交量: 38567890

600000.SH 数据概览:
  数据条数: 30
  最新价格: 8.92
  最高价: 9.45
  最低价: 8.67
  平均成交量: 32145600

000002.SZ 数据概览:
  数据条数: 30
  最新价格: 9.15
  最高价: 9.78
  最低价: 8.89
  平均成交量: 67890123
```

### 第三步：实时行情数据获取

```python
def get_realtime_data():
    """获取实时行情数据 - 改进版"""
    print("\n2. 实时行情数据获取")
    print("-" * 40)
    
    stock_codes = ['000001.SZ', '600000.SH', '000002.SZ']
    
    # 检查交易时间
    is_trading, now = is_trading_time()
    if not is_trading:
        print("  ⚠️  当前非交易时间，实时数据可能不可用")
        print(f"  当前时间: {now.strftime('%Y-%m-%d %H:%M:%S')}")
        print("  交易时间: 周一至周五 09:30-11:30, 13:00-15:00")
    
    try:
        print("获取实时tick数据...")
        tick_data = xt.get_full_tick(stock_codes)
        
        success_count = 0
        if tick_data and isinstance(tick_data, dict):
            for stock_code in stock_codes:
                if stock_code in tick_data and tick_data[stock_code]:
                    tick = tick_data[stock_code]
                    print(f"\n{stock_code} 实时数据:")
                    print(f"  最新价: {tick.get('lastPrice', 0):.2f}")
                    print(f"  涨跌幅: {tick.get('pctChg', 0):.2f}%")
                    print(f"  成交量: {tick.get('volume', 0):,}")
                    print(f"  成交额: {tick.get('amount', 0):,.0f}")
                    print(f"  买一价: {tick.get('bidPrice1', 0):.2f}")
                    print(f"  卖一价: {tick.get('askPrice1', 0):.2f}")
                    success_count += 1
                else:
                    print(f"{stock_code}: 实时数据获取失败")
        
        # 如果实时数据获取失败，尝试获取最新日线数据
        if success_count == 0:
            print("\n  实时数据不可用，获取最新日线数据作为参考...")
            latest_data = xt.get_market_data_ex(
                stock_list=stock_codes,
                period='1d',
                count=1
            )
            
            for stock_code in stock_codes:
                if stock_code in latest_data:
                    df = latest_data[stock_code]
                    if len(df) > 0:
                        latest = df.iloc[-1]
                        print(f"\n{stock_code} 最新日线数据:")
                        print(f"  收盘价: {latest['close']:.2f}")
                        print(f"  成交量: {latest['volume']:,.0f}")
                        print(f"  成交额: {latest['amount']:,.0f}")
                        print(f"  数据日期: {safe_format_time(df.index[-1])}")
                
    except Exception as e:
        print(f"获取实时数据失败: {e}")
        print("  可能的原因:")
        print("  1. 当前非交易时间")
        print("  2. 网络连接问题")
        print("  3. 数据服务权限限制")
```

### 运行效果预览

```
2. 实时行情数据获取
----------------------------------------
  ⚠️  当前非交易时间，实时数据可能不可用
  当前时间: 2024-12-31 20:15:30
  交易时间: 周一至周五 09:30-11:30, 13:00-15:00
获取实时tick数据...

  实时数据不可用，获取最新日线数据作为参考...

000001.SZ 最新日线数据:
  收盘价: 12.58
  成交量: 45,678,900
  成交额: 574,523,000
  数据日期: 2024-12-31

600000.SH 最新日线数据:
  收盘价: 8.92
  成交量: 32,145,600
  成交额: 286,739,000
  数据日期: 2024-12-31

000002.SZ 最新日线数据:
  收盘价: 9.15
  成交量: 67,890,123
  成交额: 621,234,000
  数据日期: 2024-12-31
```

### 第四步：多周期数据获取

```python
def get_multi_period_data():
    """获取多周期数据"""
    print("\n3. 多周期数据获取")
    print("-" * 40)
    
    stock_code = '000001.SZ'
    periods = ['1m', '5m', '15m', '30m', '1h', '1d']
    
    for period in periods:
        try:
            print(f"\n获取{period}周期数据...")
            data = xt.get_market_data_ex(
                stock_list=[stock_code],
                period=period,
                count=10  # 获取最近10条数据
            )
            
            if stock_code in data:
                df = data[stock_code]
                if len(df) > 0:
                    print(f"  {period}周期: 共{len(df)}条数据")
                    print(f"  最新价格: {df['close'].iloc[-1]:.2f}")
                    print(f"  时间范围: {df.index[0]} 到 {df.index[-1]}")
                else:
                    print(f"  {period}周期: 无数据")
            else:
                print(f"  {period}周期: 获取失败")
                
        except Exception as e:
            print(f"  {period}周期获取失败: {e}")
```

### 运行效果预览

```
3. 多周期数据获取
----------------------------------------

获取1m周期数据...
  1m周期: 共10条数据
  最新价格: 12.58
  时间范围: 2024-12-31 14:50:00 到 2024-12-31 14:59:00

获取5m周期数据...
  5m周期: 共10条数据
  最新价格: 12.58
  时间范围: 2024-12-31 14:05:00 到 2024-12-31 14:55:00

获取15m周期数据...
  15m周期: 共10条数据
  最新价格: 12.58
  时间范围: 2024-12-31 12:30:00 到 2024-12-31 14:45:00

获取30m周期数据...
  30m周期: 共10条数据
  最新价格: 12.58
  时间范围: 2024-12-31 10:00:00 到 2024-12-31 14:30:00

获取1h周期数据...
  1h周期: 共10条数据
  最新价格: 12.58
  时间范围: 2024-12-31 06:00:00 到 2024-12-31 14:00:00

获取1d周期数据...
  1d周期: 共10条数据
  最新价格: 12.58
  时间范围: 2024-12-18 到 2024-12-31
```

### 第五步：股票基本信息获取

```python
def get_stock_info():
    """获取股票基本信息"""
    print("\n4. 股票基本信息获取")
    print("-" * 40)
    
    stock_codes = ['000001.SZ', '600000.SH', '000002.SZ']
    
    for stock_code in stock_codes:
        try:
            print(f"\n{stock_code} 基本信息:")
            info = xt.get_instrument_detail(stock_code)
            
            if info:
                print(f"  股票名称: {info.get('InstrumentName', 'N/A')}")
                print(f"  交易所: {info.get('ExchangeID', 'N/A')}")
                print(f"  产品类别: {info.get('ProductClass', 'N/A')}")
                print(f"  最小变动价位: {info.get('PriceTick', 0)}")
                print(f"  合约乘数: {info.get('VolumeMultiple', 1)}")
                print(f"  上市日期: {info.get('OpenDate', 'N/A')}")
                print(f"  到期日期: {info.get('ExpireDate', 'N/A')}")
            else:
                print(f"  获取{stock_code}信息失败")
                
        except Exception as e:
            print(f"  获取{stock_code}信息失败: {e}")
```

### 运行效果预览

```
4. 股票基本信息获取
----------------------------------------

000001.SZ 基本信息:
  股票名称: 平安银行
  交易所: SZSE
  产品类别: 股票
  最小变动价位: 0.01
  合约乘数: 1
  上市日期: 19910403
  到期日期: N/A

600000.SH 基本信息:
  股票名称: 浦发银行
  交易所: SSE
  产品类别: 股票
  最小变动价位: 0.01
  合约乘数: 1
  上市日期: 19991110
  到期日期: N/A

000002.SZ 基本信息:
  股票名称: 万科A
  交易所: SZSE
  产品类别: 股票
  最小变动价位: 0.01
  合约乘数: 1
  上市日期: 19910129
  到期日期: N/A
```

### 第六步：板块和指数数据

```python
def get_sector_and_index_data():
    """获取板块和指数数据"""
    print("\n5. 板块和指数数据获取")
    print("-" * 40)
    
    try:
        # 获取主要指数数据
        index_codes = ['000001.SH', '399001.SZ', '399006.SZ']  # 上证指数、深证成指、创业板指
        
        print("获取主要指数数据...")
        index_data = xt.get_market_data_ex(
            stock_list=index_codes,
            period='1d',
            count=5
        )
        
        index_names = {
            '000001.SH': '上证指数',
            '399001.SZ': '深证成指', 
            '399006.SZ': '创业板指'
        }
        
        for index_code in index_codes:
            if index_code in index_data:
                df = index_data[index_code]
                if len(df) > 0:
                    latest_close = df['close'].iloc[-1]
                    prev_close = df['close'].iloc[-2] if len(df) > 1 else latest_close
                    change_pct = ((latest_close - prev_close) / prev_close) * 100
                    
                    print(f"  {index_names.get(index_code, index_code)}: {latest_close:.2f} ({change_pct:+.2f}%)")
                    
    except Exception as e:
        print(f"获取指数数据失败: {e}")
```

### 运行效果预览

```
5. 板块和指数数据获取
----------------------------------------
获取主要指数数据...
  上证指数: 2974.93 (+0.87%)
  深证成指: 9544.75 (+1.23%)
  创业板指: 1876.34 (-0.45%)
```

### 第七步：历史数据分析

```python
def analyze_historical_data():
    """分析历史数据 - 改进版"""
    print("\n6. 历史数据分析")
    print("-" * 40)
    
    stock_code = '000001.SZ'
    
    try:
        # 获取较长期的历史数据
        print(f"分析{stock_code}历史数据...")
        data = xt.get_market_data_ex(
            stock_list=[stock_code],
            period='1d',
            count=100  # 获取最近100天数据
        )
        
        if stock_code in data:
            df = data[stock_code]
            
            if len(df) > 0:
                # 基础统计 - 使用安全的时间格式化
                print(f"\n基础统计信息:")
                start_date = safe_format_time(df.index[0])
                end_date = safe_format_time(df.index[-1])
                print(f"  数据期间: {start_date} 到 {end_date}")
                print(f"  总交易日: {len(df)}天")
                
                # 价格统计
                closes = df['close']
                print(f"\n价格统计:")
                print(f"  当前价格: {closes.iloc[-1]:.2f}")
                print(f"  期间最高: {closes.max():.2f}")
                print(f"  期间最低: {closes.min():.2f}")
                print(f"  平均价格: {closes.mean():.2f}")
                print(f"  价格标准差: {closes.std():.2f}")
                
                # 涨跌统计
                daily_returns = closes.pct_change().dropna()
                up_days = (daily_returns > 0).sum()
                down_days = (daily_returns < 0).sum()
                
                print(f"\n涨跌统计:")
                print(f"  上涨天数: {up_days}天 ({up_days/len(daily_returns)*100:.1f}%)")
                print(f"  下跌天数: {down_days}天 ({down_days/len(daily_returns)*100:.1f}%)")
                print(f"  平均日收益率: {daily_returns.mean()*100:.2f}%")
                print(f"  收益率标准差: {daily_returns.std()*100:.2f}%")
                print(f"  最大单日涨幅: {daily_returns.max()*100:.2f}%")
                print(f"  最大单日跌幅: {daily_returns.min()*100:.2f}%")
                
                # 成交量统计
                volumes = df['volume']
                print(f"\n成交量统计:")
                print(f"  平均成交量: {volumes.mean():,.0f}")
                print(f"  最大成交量: {volumes.max():,.0f}")
                print(f"  最小成交量: {volumes.min():,.0f}")
                
                # 简单技术指标
                print(f"\n简单技术指标:")
                ma5 = closes.rolling(5).mean().iloc[-1]
                ma20 = closes.rolling(20).mean().iloc[-1]
                ma60 = closes.rolling(60).mean().iloc[-1] if len(closes) >= 60 else None
                
                print(f"  MA5: {ma5:.2f}")
                print(f"  MA20: {ma20:.2f}")
                if ma60:
                    print(f"  MA60: {ma60:.2f}")
                
                # 价格相对位置
                current_price = closes.iloc[-1]
                print(f"\n价格相对位置:")
                print(f"  相对MA5: {((current_price/ma5-1)*100):+.2f}%")
                print(f"  相对MA20: {((current_price/ma20-1)*100):+.2f}%")
                if ma60:
                    print(f"  相对MA60: {((current_price/ma60-1)*100):+.2f}%")
                        
            else:
                print(f"  {stock_code}无历史数据")
        else:
            print(f"  获取{stock_code}数据失败")
            
    except Exception as e:
        print(f"分析历史数据失败: {e}")
```

### 运行效果预览

```
6. 历史数据分析
----------------------------------------
分析000001.SZ历史数据...

基础统计信息:
  数据期间: 2024-08-23 到 2024-12-31
  总交易日: 100天

价格统计:
  当前价格: 12.58
  期间最高: 13.89
  期间最低: 11.23
  平均价格: 12.45
  价格标准差: 0.67

涨跌统计:
  上涨天数: 52天 (52.5%)
  下跌天数: 47天 (47.5%)
  平均日收益率: 0.08%
  收益率标准差: 1.85%
  最大单日涨幅: 6.78%
  最大单日跌幅: -5.23%

成交量统计:
  平均成交量: 42,567,890
  最大成交量: 89,234,567
  最小成交量: 18,456,789

简单技术指标:
  MA5: 12.52
  MA20: 12.38
  MA60: 12.41

价格相对位置:
  相对MA5: +0.48%
  相对MA20: +1.62%
  相对MA60: +1.37%
```

### 第八步：数据质量检查

```python
def check_data_quality():
    """检查数据质量 - 改进版"""
    print("\n8. 数据质量检查")
    print("-" * 40)
    
    stock_codes = ['000001.SZ', '600000.SH', '000002.SZ']
    
    for stock_code in stock_codes:
        try:
            print(f"\n检查{stock_code}数据质量:")
            
            data = xt.get_market_data_ex(
                stock_list=[stock_code],
                period='1d',
                count=50
            )
            
            if stock_code in data:
                df = data[stock_code]
                
                if len(df) > 0:
                    # 检查缺失值
                    missing_data = df.isnull().sum()
                    print(f"  缺失值检查:")
                    for col in ['open', 'high', 'low', 'close', 'volume']:
                        if col in missing_data:
                            print(f"    {col}: {missing_data[col]}个缺失值")
                    
                    # 检查异常值
                    print(f"  异常值检查:")
                    
                    # 检查价格逻辑
                    price_errors = 0
                    for i in range(len(df)):
                        row = df.iloc[i]
                        if row['high'] < row['low']:
                            price_errors += 1
                        if row['close'] > row['high'] or row['close'] < row['low']:
                            price_errors += 1
                        if row['open'] > row['high'] or row['open'] < row['low']:
                            price_errors += 1
                    
                    print(f"    价格逻辑错误: {price_errors}个")
                    
                    # 检查零值
                    zero_volumes = (df['volume'] == 0).sum()
                    zero_prices = (df['close'] == 0).sum()
                    
                    print(f"    零成交量: {zero_volumes}天")
                    print(f"    零价格: {zero_prices}天")
                    
                    # 数据连续性检查 - 使用安全的日期计算
                    date_gaps = 0
                    if len(df) > 1:
                        for i in range(1, len(df)):
                            days_diff = safe_calculate_days_diff(df.index[i], df.index[i-1])
                            if days_diff > 3:  # 超过3天的间隔可能是数据缺失
                                date_gaps += 1
                    
                    print(f"    日期间隔异常: {date_gaps}个")
                    
                    if price_errors == 0 and zero_prices == 0 and date_gaps == 0:
                        print(f"  ✅ 数据质量良好")
                    else:
                        print(f"  ⚠️  发现数据质量问题")
                        
                else:
                    print(f"  ❌ 无数据")
            else:
                print(f"  ❌ 数据获取失败")
                
        except Exception as e:
            print(f"  ❌ 检查失败: {e}")
```

### 运行效果预览

```
8. 数据质量检查
----------------------------------------

检查000001.SZ数据质量:
  缺失值检查:
    open: 0个缺失值
    high: 0个缺失值
    low: 0个缺失值
    close: 0个缺失值
    volume: 0个缺失值
  异常值检查:
    价格逻辑错误: 0个
    零成交量: 0天
    零价格: 0天
    日期间隔异常: 0个
  ✅ 数据质量良好

检查600000.SH数据质量:
  缺失值检查:
    open: 0个缺失值
    high: 0个缺失值
    low: 0个缺失值
    close: 0个缺失值
    volume: 0个缺失值
  异常值检查:
    价格逻辑错误: 0个
    零成交量: 0天
    零价格: 0天
    日期间隔异常: 0个
  ✅ 数据质量良好

检查000002.SZ数据质量:
  缺失值检查:
    open: 0个缺失值
    high: 0个缺失值
    low: 0个缺失值
    close: 0个缺失值
    volume: 0个缺失值
  异常值检查:
    价格逻辑错误: 0个
    零成交量: 0天
    零价格: 0天
    日期间隔异常: 0个
  ✅ 数据质量良好
```

## 关键知识点

### 1. 数据获取策略
- **多重导入机制**: 支持多种导入方式确保模块加载成功
- **异常处理**: 完善的错误处理和降级方案
- **数据验证**: 获取数据后进行完整性验证
- **重试机制**: 网络异常时的自动重试

### 2. 实时数据处理
- **交易时间检查**: 智能判断当前是否为交易时间
- **数据降级**: 实时数据不可用时使用最新日线数据
- **多源数据**: 支持tick数据和日线数据的灵活切换
- **状态监控**: 实时监控数据获取状态

### 3. 多周期数据分析
- **周期覆盖**: 支持1分钟到日线的全周期数据
- **数据统一**: 标准化不同周期的数据格式
- **时间对齐**: 确保不同周期数据的时间一致性
- **性能优化**: 批量获取提高效率

### 4. 数据质量保证
- **完整性检查**: 检查数据的完整性和连续性
- **逻辑验证**: 验证价格数据的逻辑合理性
- **异常检测**: 识别和标记异常数据点
- **质量评分**: 对数据质量进行量化评估

### 5. 高级功能特性
- **安全时间处理**: 兼容多种时间格式的安全转换
- **智能降级**: 数据获取失败时的智能降级策略
- **批量处理**: 支持多股票批量数据获取
- **内存优化**: 大数据量处理的内存优化

### 6. 最佳实践建议
- **错误恢复**: 建立完善的错误恢复机制
- **数据缓存**: 合理使用缓存减少重复请求
- **性能监控**: 监控数据获取的性能指标
- **版本兼容**: 确保代码在不同版本间的兼容性

---

## 扫码关注

![微信公众号二维码](wechat_qr.png)

欢迎扫码持续关注公众号，会持续分享