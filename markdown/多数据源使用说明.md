# 多数据源回测系统使用说明

## 📊 功能概述

本系统已成功升级为支持多数据源的回测系统，数据源优先级为：
**QMT → QStock → AKShare → 模拟数据**

## 🎯 数据源说明

### 1. QMT数据源
- **描述**: 通过MiniQMT获取真实市场数据
- **优点**: 数据最准确，实时性好
- **要求**: 需要安装并启动MiniQMT客户端
- **状态**: ✅ 已连接 / ⚠️ 未连接 / ❌ 不可用

### 2. QStock数据源  
- **描述**: 通过qstock库获取股票数据
- **优点**: 轻量级，无需客户端
- **要求**: 需要安装qstock库 (`pip install qstock`)
- **状态**: ✅ 已连接 / ❌ 不可用

### 3. AKShare数据源
- **描述**: 通过akshare库获取股票数据
- **优点**: 数据源丰富，免费使用
- **要求**: 需要安装akshare库 (`pip install akshare`)
- **状态**: ✅ 已连接 / ❌ 不可用

### 4. 模拟数据源
- **描述**: 生成符合统计特征的模拟数据
- **优点**: 始终可用，用于测试和演示
- **特点**: 基于股票代码生成固定的随机数据
- **状态**: ✅ 始终可用

## 🔧 使用方法

### 在回测界面中使用

1. **自动选择模式**（推荐）
   - 选择"自动选择 (QMT→QStock→AKShare→模拟)"
   - 系统会按优先级自动尝试各个数据源
   - 使用第一个可用的数据源

2. **强制指定数据源**
   - 选择"强制QMT"、"强制QStock"、"强制AKShare"或"强制模拟数据"
   - 系统只使用指定的数据源
   - 如果指定数据源不可用，回测将失败

3. **数据源状态监控**
   - 界面会实时显示当前活跃的数据源
   - 鼠标悬停在状态标签上可查看详细状态
   - 点击"🔄 刷新连接"按钮可重新检测所有数据源

### 编程接口使用

```python
from gui_app.backtest.data_manager import DataManager, DataSource

# 初始化数据管理器
dm = DataManager()

# 自动选择数据源
data = dm.get_stock_data('000001.SZ', '2024-01-01', '2024-01-31')

# 强制使用特定数据源
data_qmt = dm.get_stock_data('000001.SZ', '2024-01-01', '2024-01-31', 
                            force_source=DataSource.QMT)

# 设置首选数据源
dm.set_preferred_source(DataSource.AKSHARE)

# 获取连接状态
status = dm.get_connection_status()
print(f"活跃数据源: {status['active_source']}")
```

## 📈 数据格式

所有数据源返回的数据都会被标准化为统一格式：

```python
DataFrame格式:
- 索引: 日期 (DatetimeIndex)
- 列:
  - open: 开盘价
  - high: 最高价  
  - low: 最低价
  - close: 收盘价
  - volume: 成交量
```

## 🔍 故障排除

### 常见问题

1. **QMT连接失败**
   ```
   症状: 显示"QMT未连接"
   解决: 
   - 确保MiniQMT客户端已启动并登录
   - 检查xtquant库是否正确安装
   - 点击"刷新连接"重新检测
   ```

2. **QStock不可用**
   ```
   症状: 显示"qstock模块未安装"
   解决: pip install qstock
   ```

3. **AKShare不可用**
   ```
   症状: 显示"akshare模块未安装"  
   解决: pip install akshare
   ```

4. **所有数据源都失败**
   ```
   症状: 只能使用模拟数据
   解决: 
   - 检查网络连接
   - 确认相关库已正确安装
   - 查看控制台错误信息
   ```

### 数据质量检查

系统会自动进行数据质量检查：
- 删除空值和异常值
- 验证价格关系合理性（high ≥ max(open,close), low ≤ min(open,close)）
- 过滤异常波动（单日涨跌幅>20%）
- 确保成交量为正数

## 🎮 界面功能

### 数据源选择下拉框
- **自动选择**: 按优先级自动选择可用数据源
- **强制QMT**: 仅使用QMT数据源
- **强制QStock**: 仅使用QStock数据源  
- **强制AKShare**: 仅使用AKShare数据源
- **强制模拟数据**: 仅使用模拟数据

### 状态显示
- **✅ 绿色**: 数据源已连接，使用真实数据
- **⚠️ 橙色**: 数据源未连接，使用备用方案
- **🎲 橙色**: 使用模拟数据
- **❌ 红色**: 数据源不可用

### 刷新功能
- 点击"🔄 刷新连接"可重新检测所有数据源状态
- 系统会自动更新状态显示和工具提示

## 📝 更新日志

### v2.0 - 多数据源支持
- ✅ 新增QStock数据源支持
- ✅ 新增AKShare数据源支持  
- ✅ 实现数据源自动切换
- ✅ 添加数据源手动选择功能
- ✅ 优化数据源状态检测
- ✅ 统一数据格式标准化
- ✅ 增强数据质量检查
- ✅ 改进用户界面体验

### 兼容性
- 完全向后兼容原有QMT数据源
- 保持原有回测引擎接口不变
- 新增功能不影响现有代码

## 🚀 性能优化

- 数据源检测采用超时机制，避免长时间阻塞
- 并行检测多个数据源状态
- 智能缓存连接状态，减少重复检测
- 数据清洗优化，提高处理速度

## 📞 技术支持

如遇到问题，请：
1. 查看控制台输出的详细错误信息
2. 确认相关依赖库已正确安装
3. 检查网络连接和数据源服务状态
4. 尝试使用不同的数据源进行测试

---

**注意**: 本系统优先使用真实市场数据，只有在所有真实数据源都不可用时才会使用模拟数据。建议在生产环境中确保至少有一个真实数据源可用。